generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  
  // Profile fields
  fullName  String?  @map("full_name") @db.VarChar(100)
  country   String?  @db.VarChar(100)
  province  String?  @db.VarChar(100)
  city      String?  @db.VarChar(100)
  whatsapp  String?  @db.VarChar(50)
  avatar    String?

  // Role and Status
  roleId    Int      @default(2) @map("role_id")
  status    Boolean  @default(true)

  role             Role      @relation(fields: [roleId], references: [id])
  products         Product[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  questions        Question[]
  paymentMethods   PaymentMethod[]
  buyOrders        Order[]       @relation("BuyerOrders")
  sellOrders       Order[]       @relation("SellerOrders")

  @@map("users")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50) 
  // 1: Administrador, 2: Usuario

  users User[]

  @@map("roles")
}

model Product {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  images      String[]
  categoryId  Int?     @map("category_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  user     User?     @relation(fields: [userId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
  questions Question[]
  orderItems OrderItem[]

  @@map("products")
}

model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(100)
  
  products Product[]

  @@map("categories")
}

model Message {
  id         Int      @id @default(autoincrement())
  fromUserId Int?     @map("from_user")
  toUserId   Int?     @map("to_user")
  content    String   @db.Text
  readStatus Boolean? @default(false) @map("read_status")
  createdAt  DateTime @default(now()) @map("created_at")

  fromUser User? @relation("SentMessages", fields: [fromUserId], references: [id])
  toUser   User? @relation("ReceivedMessages", fields: [toUserId], references: [id])

  @@map("messages")
}

model Question {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  userId    Int      @map("user_id")
  content   String   @db.Text
  answer    String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("questions")
}

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  provider    String   @db.VarChar(50) // 'MERCADOPAGO', 'UALA', 'PAYPAL'
  accessToken String   @map("access_token") @db.Text
  publicKey   String?  @map("public_key") @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, provider]) // Un token por proveedor por usuario
  @@map("payment_methods")
}

model Order {
  id          Int      @id @default(autoincrement())
  buyerId     Int?     @map("buyer_id") // Can be null for manual sales if buyer unknown
  sellerId    Int      @map("seller_id")
  total       Decimal  @db.Decimal(10, 2)
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, MANUAL
  paymentId   String?  @map("payment_id") // MercadoPago Payment ID
  createdAt   DateTime @default(now()) @map("created_at")

  buyer       User?    @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller      User     @relation("SellerOrders", fields: [sellerId], references: [id])
  items       OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int     @map("order_id")
  productId Int     @map("product_id")
  title     String  @db.VarChar(255)
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}
